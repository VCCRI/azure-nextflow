# Authentication
# Set up the following secrets in your GitHub repository: 
#
#   AZURE_CREDENTIALS
#
# For details on usage of secrets, please refer to:
#  https://help.github.com/en/actions/configuring-and-managing-workflows/creating-and-storing-encrypted-secrets

name: Build and deploy Azure templates

on: 
  workflow_dispatch:
    inputs:
      AZURE_LOCATION: 
        description: 'Azure region name'
        required: true
        default: 'australiaeast'
      AZURE_SUBSCRIPTION_ID:
        description: 'Azure subscription id'
        required: true

env:
  AZURE_LOCATION: ${{ github.event.inputs.AZURE_LOCATION }}
  AZURE_SUBSCRIPTION_ID: ${{ github.event.inputs.AZURE_SUBSCRIPTION_ID }}
  BICEP_FILE_PATH: './azure/templates'
  BICEP_FILE_NAME: 'main'
  BICEP_OUTPUT_DIRECTORY: './azure/templates/builds'

jobs:
  validate_and_deploy:
    runs-on: ubuntu-latest 
    steps:
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    # Checkout
    - name: 'Checkout repository branch'
      uses: actions/checkout@v1

    # Build ARM Template from Bicep
    - name: Azure CLI - Validate Bicep file ${{ env.BICEP_FILE_PATH }}/${{ env.BICEP_FILE_NAME }}.bicep
      uses: Azure/cli@1.0.4
      with:
        inlineScript: |
          mkdir -p ${{ env.BICEP_OUTPUT_DIRECTORY }}
          az deployment sub validate --name ${{ github.run_number }} --location ${{ env.AZURE_LOCATION }} --subscription ${{ env.AZURE_SUBSCRIPTION_ID }} --template-file ${{ env.BICEP_FILE_PATH }}/${{ env.BICEP_FILE_NAME }}.bicep
          az bicep upgrade 
          az bicep build --file ${{ env.BICEP_FILE_PATH }}/${{ env.BICEP_FILE_NAME }}.bicep --outdir ${{ env.BICEP_OUTPUT_DIRECTORY }}
    
    # Deployment Bicep template
    - name: Deploy infrastructure
      id: infraDeployment
      uses: azure/arm-deploy@v1
      with:
        deploymentName: ${{ github.run_number }}
        location: ${{ env.AZURE_LOCATION }} 
        subscription: ${{ env.AZURE_SUBSCRIPTION_ID }}
        template: ${{ env.BICEP_OUTPUT_DIRECTORY }}/${{ env.BICEP_FILE_NAME }}.json

    # Azure logout
    - name: logout
      run: |
        az logout
      if: always()        